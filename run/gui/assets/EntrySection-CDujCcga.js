import{r as p,j as e,w as N,a7 as E,o as P,bK as J,bk as K,ai as $,a0 as z,l as Y,m as q,B as j,T as H,ae as A,u as U,v as X}from"./material-react-table-Clsq1WEk.js";import{aI as Z,as as I,au as Q,u as y,h as ee,g as L,aJ as ne,F as te,l as k,aK as se,aL as B,aM as D,aN as ie,d as ae,e as C,aO as re,aP as oe,b as le,aQ as ce}from"./index-ByzPaSZm.js";import{e as de,b as ue,S as R,d as fe,f as he,Q as xe}from"./SectionProvider-BGIb-Rry.js";import{E as b}from"./ErrorBoundary-DVJerO_f.js";import{_ as F}from"./tslib.es6-I3t2aBBq.js";import{u as T}from"./EntryContext-DBKD7XKl.js";function me(n,t,s){t===void 0&&(t=[]),s===void 0&&(s={loading:!1});var r=p.useRef(0),d=Z(),h=p.useState(s),l=h[0],a=h[1],c=p.useCallback(function(){for(var o=[],u=0;u<arguments.length;u++)o[u]=arguments[u];var g=++r.current;return l.loading||a(function(x){return F(F({},x),{loading:!0})}),n.apply(void 0,o).then(function(x){return d()&&g===r.current&&a({value:x,loading:!1}),x},function(x){return d()&&g===r.current&&a({error:x,loading:!1}),x})},t);return[l,c]}function pe(){const{redo:n,redoStack:t}=I();return e.jsx(N,{disabled:t.length===0,onClick:()=>n(),children:e.jsx(de,{})})}function ge(){const{user:n}=Q(),{reload:t}=y(),{entry_id:s}=ee(),{changeStack:r,clearChangeStack:d}=I(),[h,l]=me(async()=>{const a=r.map(c=>{const o={...c},u=c.new_value;return u?.m_def&&(o.new_value={...u},delete o.new_value.m_def),o.oldValue&&delete o.oldValue,o});L(n,"User must be defined at this point"),await ne(s,a,n),d(),t()},[r,d,t]);return e.jsx(E,{title:r.length===0?"No changes to save":h.loading?"Saving changes...":"Save changes to archive",children:e.jsx("span",{children:e.jsx(P,{disabled:r.length===0||h.loading,variant:"contained",onClick:l,startIcon:e.jsx(J,{}),children:"Save"})})})}function je(){const{undo:n,changeStack:t}=I();return e.jsx(N,{disabled:t.length===0,onClick:()=>n(),children:e.jsx(ue,{})})}function W(n){const{search:t}=y();return t}function ve(){const{navigate:n}=y(),{preview:t}=W(),s=p.useCallback(()=>{n({searchUpdates:{preview:t?void 0:!0}})},[n,t]);return e.jsx(K,{children:e.jsx($,{control:e.jsx(z,{checked:!!t,onChange:s}),label:"Preview"})},"preview")}function be({definition:n,editable:t=!1,disableUnavailable:s=!0}){return e.jsx(fe,{layout:{label:he(n.name),type:"subSectionNav",property:n.name,editable:t,disableUnavailable:s}})}function ye({definition:n,editable:t=!1,divider:s=null}){return e.jsxs(e.Fragment,{children:[s,e.jsx(xe,{layout:{type:"quantity",property:n.name,editable:t}})]})}function _e(n){return!!n.m_annotations?.eln&&n?.m_annotations?.display?.[0]?.editable!==!1}function Se({path:n,writable:t=!1,editable:s=!1,disableUnavailable:r=!0}){const{location:d,navigate:h}=y(),{value:l,loading:a}=te(n),c=l?.m_def,o=k.isNil(l)||k.isEmpty(l),u=p.useCallback(()=>{const i=se(d),f=i[i.length-2]?.path||"";h({path:f})},[h,d]),g=p.useMemo(()=>{if(a||o)return[];const i=c?.m_annotations?.eln?.[0]?.properties,f=c?.m_annotations?.display?.[0],S=c?.m_annotations?.eln?.[0]?.hide||[],w=Object.keys(c.all_properties),V=B(i?.visible,w),G=B(i?.editable,w);let v=Object.values(c.all_properties);v=v.filter(m=>V.includes(m.name)),v=v.filter(m=>!(S.includes(m.name)||m?.m_annotations?.display?.[0]?.visible===!1));const O=[...i?.order||f?.order||[]].reverse();return v.sort((m,M)=>O.indexOf(M.name)-O.indexOf(m.name)||(m.m_parent_index||0)-(M.m_parent_index||0)),v.map(m=>({definition:m,editable:m.m_def===D?s&&_e(m)&&(i?.editable?G.includes(m.name):!0):s}))},[c,a,o,s]),x=p.useMemo(()=>{if(a||o)return[];let i=g.filter(f=>f.definition.m_def===D&&n!==""&&f.definition.name!=="processing_logs");return!s&&r&&(i=i.filter(f=>!k.isNil(l[f.definition.name]))),i},[s,r,l,a,o,g,n]),_=p.useMemo(()=>{if(a||o)return[];let i=g.filter(f=>f.definition.m_def===ie);return!s&&r&&(i=i.filter(f=>{const S=l[f.definition.name];return n===""&&f.definition.name==="data"?!0:!k.isNil(S)&&Object.keys(S).some(w=>w!=="m_def")})),i},[s,r,n,l,a,o,g]);return a?"Loading...":e.jsxs(e.Fragment,{children:[e.jsx(ae,{title:e.jsx(C,{title:c?.name,sx:{mt:0,mb:0}}),secondaryActions:e.jsxs(e.Fragment,{children:[t&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{}),e.jsx(je,{}),e.jsx(pe,{}),e.jsx(ge,{})]}),e.jsx(E,{title:"View JSON",children:e.jsx(P,{variant:"outlined",children:e.jsx(re,{})})}),e.jsx(E,{title:"Go to parent section",children:e.jsx("span",{children:e.jsx(P,{variant:"outlined",onClick:u,disabled:n==="",children:e.jsx(oe,{})})})})]})}),e.jsx(Y,{sx:{width:"100%"},children:e.jsx(q,{sx:{display:"flex",flexDirection:"column",gap:2},children:e.jsxs(j,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",gap:0},children:[_.length===0&&x.length===0&&e.jsx(H,{children:"Empty section"}),c?.name!=="EntryArchive"&&x.length>0&&e.jsxs(b,{children:[e.jsx(C,{variant:"h3",sx:{mt:0},children:"Quantities"}),e.jsxs(j,{sx:{display:"flex",flexDirection:"column",paddingLeft:1.5},children:[e.jsx(R,{path:n,children:x.map(i=>e.jsx(j,{children:e.jsx(b,{children:e.jsx(ye,{definition:i.definition,editable:i.editable,divider:e.jsx(A,{sx:{mt:.5,mb:.5}})})})},i.definition.name))}),_.length!==0&&x.length!==0&&e.jsx(A,{sx:{my:1}})]})]}),_.length>0&&e.jsxs(b,{children:[e.jsx(C,{variant:"h3",sx:{mt:0},children:"Subsections"}),e.jsx(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:e.jsx(R,{path:n,children:_.map(i=>e.jsx(b,{children:e.jsx(be,{definition:i.definition,editable:i.editable,disableUnavailable:r})},i.definition.name))})})]})]})})})]})}function we(){const{user:n}=Q(),{index:t}=T(),{viewers:s,viewer_groups:r,writers:d,writer_groups:h,process_running:l,published:a,with_embargo:c}=t;if(!(d&&h&&s&&r))return{canRead:!1,canWrite:!1};L(a!==void 0&&c!==void 0,"published data missing in route data");const o=n?.profile?.sub;return{canRead:a&&!c||s.map(u=>u.user_id).includes(o),canWrite:!l&&!a&&d.map(u=>u.user_id).includes(o)}}function ke(){const n=U(),t=X(n.breakpoints.up("xl"));return e.jsx(j,{sx:{width:t?`${ce}px`:0,minWidth:0}})}function Ce(){const{path:n}=y(),{canWrite:t}=we(),{isPage:s}=le(),{preview:r}=W(),d=n.slice(8),{index:h}=T(),l=t&&s,a=d.startsWith("data")&&!r&&h.parser_name==="parsers/archive"&&l;return e.jsx(b,{children:e.jsxs(j,{sx:{display:"flex",flexDirection:"row",gap:2,width:"100%",height:"100%"},children:[e.jsx(j,{sx:{flex:1,overflowY:"auto",paddingRight:2},children:e.jsx(Se,{path:d,writable:l,editable:a})}),e.jsx(ke,{})]})})}const De=Object.freeze(Object.defineProperty({__proto__:null,default:Ce},Symbol.toStringTag,{value:"Module"}));export{je as E,ve as P,pe as a,ge as b,W as c,Ce as d,De as e,we as u};
